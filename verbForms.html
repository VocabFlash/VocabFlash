<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbForms - VocabFlash</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="data/verbForms.js" defer></script>
    <script defer>
        let currentVerb; // Aktuelles Verb
        let currentIndex = 0; // Index des aktuellen Verbs
        let wrongAttempts = 0; // Anzahl der falschen Versuche
        let wrongAnswers = []; // Falsche Antworten speichern
        let secondRound = false; // Überprüfen, ob es die zweite Runde ist
        let currentSet = []; // Aktuelles Set von Verben
        let currentTense; // Aktuelle Zeitform
        let timer; // Timer für automatisches Weiterspringen
        let results = []; // Ergebnisse speichern
        let submitButton;
        let skipButton;

        // VERB ANZEIGEN
        function displayVocabWord() {
            if (currentSet.length > 0 && currentIndex < currentSet.length) {
                const vocab = currentSet[currentIndex];
                document.getElementById('selectedVerb').innerText = `Selected Verb: ${vocab.verb}`;
                document.getElementById('inputCounter').innerText = `Word: ${currentIndex + 1} / ${currentSet.length}`;
                submitButton.style.display = "block"; // Zeige den Check-Button
                skipButton.style.display = "none"; // Verstecke den Skip-Button
                clearInputs(); // Eingabefelder zurücksetzen
                clearFeedback(); // Feedback entfernen
            } else {
                alert("All verbs in the set are completed!");
            }
        }

        // ZUM NÄCHSTEN WORT WECHSELN
        function nextWord() {
            clearTimeout(timer);
            wrongAttempts = 0;
            clearFeedback();

            if (currentIndex < currentSet.length - 1) {
                currentIndex++;
                displayVocabWord();
            } else {
                alert("You have completed all the verbs in the current set.");
                currentIndex = 0;
            }
        }

        // SET AKTUALISIEREN
        function updateVerbSet() {
            const selectedSet = document.getElementById('setSelect').value;
            const selectedTense = document.getElementById('tenseSelect').value;

            if (verbSets[selectedSet]) {
                currentSet = verbSets[selectedSet];
                currentTense = selectedTense;
                currentIndex = 0;
                wrongAnswers = [];
                displayVocabWord();
            } else {
                console.error("Set not found: ", selectedSet);
            }
        }

        // TIMER START
        function startTimer() {
            timer = setTimeout(nextWord, 4000);
        }

        // TASTATUR-EINGABEN BEHANDELN
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                const checkButton = document.getElementById('submitConjugation');
                if (checkButton.style.display !== 'none') {
                    checkAnswers();
                } else if (skipButton.style.display !== 'none') {
                    skipToNext();
                }
            } else if (event.key === 'PageDown') {
                const currentInput = document.activeElement;
                const inputs = Array.from(document.querySelectorAll('input[type="text"]'));
                const currentIndex = inputs.indexOf(currentInput);
                const nextInput = inputs[currentIndex + 1];
                if (nextInput) {
                    nextInput.focus();
                }
            }
        }

        // SKIP-BUTTON AKTION
        function skipToNext() {
            clearTimeout(timer);
            nextWord();
        }

        // ANTWORTEN ÜBERPRÜFEN
        function checkAnswers() {
            const correctAnswers = {
                je: conjugate(currentVerb, currentTense, 'je').replace('je ', ''),
                tu: conjugate(currentVerb, currentTense, 'tu').replace('tu ', ''),
                ilElle: conjugate(currentVerb, currentTense, 'il').replace('il ', ''),
                nous: conjugate(currentVerb, currentTense, 'nous').replace('nous ', ''),
                vous: conjugate(currentVerb, currentTense, 'vous').replace('vous ', ''),
                ilsElles: conjugate(currentVerb, currentTense, 'ils').replace('ils ', '')
            };

            let allCorrect = true;
            for (const pronoun in correctAnswers) {
                const userAnswer = document.getElementById(`input${pronoun.charAt(0).toUpperCase() + pronoun.slice(1)}`).value.trim();
                const feedbackElement = document.getElementById(`feedback${pronoun.charAt(0).toUpperCase() + pronoun.slice(1)}`);

                if (userAnswer === correctAnswers[pronoun]) {
                    feedbackElement.innerHTML = 'Correct!';
                    feedbackElement.className = 'feedback correct';
                } else {
                    feedbackElement.innerHTML = `Wrong! Correct answer: ${correctAnswers[pronoun]}`;
                    feedbackElement.className = 'feedback wrong';
                    wrongAnswers.push(pronoun);
                    allCorrect = false;
                }
            }

            if (allCorrect || wrongAttempts >= 2) {
                skipButton.style.display = "block";
                submitButton.style.display = "none";
                startTimer();
            } else {
                wrongAttempts++;
            }

            if (currentIndex === currentSet.length - 1 && allCorrect) {
                showResults();
            }
        }

        //FEEDBACK ENTFERNEN
        function clearFeedback() {
            ['Je', 'Tu', 'IlElle', 'Nous', 'Vous', 'IlsElles'].forEach(pronoun => {
                const feedbackElement = document.getElementById(`feedback${pronoun}`);
                feedbackElement.innerHTML = '';
                feedbackElement.className = 'feedback';
            });
        }

        // EINGABEFELDER LÖSCHEN
        function clearInputs() {
            ['Je', 'Tu', 'IlElle', 'Nous', 'Vous', 'IlsElles'].forEach(pronoun => {
                document.getElementById(`input${pronoun}`).value = '';
            });
        }

        // ERGEBNISSE ANZEIGEN
        function showResults() {
            const mode = "verbForms";
            localStorage.setItem("verbInputResults", JSON.stringify(results));
            const currentPage = window.location.pathname.split("/").pop();
            window.location.href = `result.html?fromPage=${currentPage}&mode=${mode}`;
        }

        // VERB LADEN
        function loadVerbForConjugation() {
            clearTimeout(timer);
            updateVerbSet();
        }

        document.addEventListener('DOMContentLoaded', () => {
            submitButton = document.getElementById('submitConjugation');
            skipButton = document.getElementById('skipButton');
        });
    </script>
</head>
<body>
    <h1>VocabFlash</h1>
    <h2 id="inputCounter">Verb: 1 / 10</h2>

    <div class="container">
        <h3 id="selectedVerb">Selected Verb: </h3>
        <table id="conjugationTable">
            <thead>
                <tr>
                    <th>Pronoun</th>
                    <th>Your Answer</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>je</td>
                    <td>
                        <input type="text" id="inputJe" onkeydown="handleKeyDown(event)">
                        <span id="feedbackJe" class="feedback"></span>
                    </td>
                </tr>
                <!-- Repeat for tu, il/elle, nous, vous, ils/elles -->
            </tbody>
        </table>
        
        <button class="confirm-button" id="submitConjugation" onclick="checkAnswers()">Check</button>
        <button class="confirm-button" id="skipButton" onclick="skipToNext()" style="display: none;">Skip</button>
    </div>

    <div class="container">
        <label for="setSelect">Choose a verb set:</label>
        <select id="setSelect" onchange="updateVerbSet()">
            <option value="reg1">er-Verbs</option>
            <option value="cerVerbs">cer-Verbs</option>
            <!-- Other sets -->
        </select>

        <label for="tenseSelect">Choose a tense:</label>
        <select id="tenseSelect">
            <option value="present">Present</option>
            <option value="passeCompose">Passé Composé</option>
            <option value="imparfait">Imparfait</option>
            <option value="mixed">Mixed</option>
        </select>
        
        <button class="confirm-button" onclick="loadVerbForConjugation()">Confirm</button>
    </div>
</body>
</html>
